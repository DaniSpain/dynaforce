var DEFAULT_INSTANCE_URL="http://na1.salesforce.com",DEFAULT_API_VERSION="v26.0",DEFAULT_LOGINAPI_URL="https://login.salesforce.com/services/oauth2/token",DEFAULT_LOGIN_URL="https://login.salesforce.com/services/oauth2/authorize",DEFAULT_REDIRECT_URI="https://login.salesforce.com/services/oauth2/success",DEFAULT_TIMEOUT=5E3,STATUS_OK="HTTP/1.1 200 OK",STATUS_ERROR="ERROR";
exports.versions=function(a){httpRequest({type:"GET",url:(a.instanceUrl||DEFAULT_INSTANCE_URL)+"/services/data/",success:a.success,error:a.error,progress:a.progress,beforeSend:a.beforeSend,accept:a.accept||"application/json"})};exports.ConnectedApp=ConnectedApp;
function ConnectedApp(a){a=a||{};a.consumerKey||Ti.API.warn("consumerKey is missing");a.consumerSecret||Ti.API.warn("consumerSecret is missing.");this.apiVersion=a.apiVersion||DEFAULT_API_VERSION;this.instanceUrl=null;this.timeout=a.timeout||DEFAULT_TIMEOUT;this.consumerKey=a.consumerKey;this.consumerSecret=a.consumerSecret;this.currentUser=a.currentUser||null;this.securityToken=a.securityToken||"";this.accessToken=a.accessToken;this.refreshToken=a.refreshToken;this.isLoggedIn=!1;this.loginUrl=a.loginUrl;
this.redirectUri=a.redirectUri||DEFAULT_REDIRECT_URI;this.headers=null;this.contentType=a.contentType||"application/json";this.accept=a.accept||"application/json";this.operations=new Operations(this)}ConnectedApp.prototype.sobjects=function(a){this.operations.validate(a,{authorized:!0}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"})};
ConnectedApp.prototype.metadata=function(a){this.operations.validate(a,{authorized:!0,required:["name"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name})};ConnectedApp.prototype.describe=function(a){this.operations.validate(a,{authorized:!0,required:["name"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name+"/describe"})};
ConnectedApp.prototype.create=function(a){this.operations.validate(a,{authorized:!0,required:["name","data"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name,type:"POST",data:a.data})};
ConnectedApp.prototype.retrieve=function(a){var b;this.operations.validate(a,{authorized:!0,required:["name","id"]}).then(function(){b=this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name+"/"+a.id;a.fields&&(b=a.fields instanceof Array?b+("?fields="+a.fields.join(",")):b+("?fields="+a.fields))}).sendRequest(a,{url:b})};
ConnectedApp.prototype.update=function(a){this.operations.validate(a,{authorized:!0,required:["name","id","data"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name+"/"+a.id+"?_HttpMethod=PATCH",type:"POST",data:a.data})};ConnectedApp.prototype.remove=function(a){this.operations.validate(a,{authorized:!0,required:["name","id"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name+"/"+a.id,type:"DELETE"})};
ConnectedApp.prototype.upsertBlob=function(a){var b,c,h,e,d;this.operations.validate(a,{authorized:!0,required:["name","data","blob","blobField"]}).then(function(){b=this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name;a.id&&(b+="/"+a.id+"?_HttpMethod=PATCH");c=a.contentType||this.contentType;h=""+Ti.Utils.base64encode(a.blob);isJSON(c)?a.data[a.blobField]=h:isXML(c)&&(e=a.data.createElement(a.blobField),d=a.data.createTextNode(h),e.appendChild(d),a.data.documentElement.appendChild(e))}).sendRequest(a,
{url:b,type:"POST",data:a.data}).then(function(){isJSON(c)?delete a.data[a.blobField]:isXML(c)&&a.data.documentElement.removeChild(e)})};ConnectedApp.prototype.retrieveBlob=function(a){this.operations.validate(a,{authorized:!0,required:["name","id","blobField"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name+"/"+a.id+"/"+a.blobField})};
ConnectedApp.prototype.retrieveExternal=function(a){this.operations.validate(a,{authorized:!0,required:["name","fieldName","fieldValue"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name+"/"+a.fieldName+"/"+a.fieldValue})};
ConnectedApp.prototype.upsertExternal=function(a){this.operations.validate(a,{authorized:!0,required:["name","fieldName","fieldValue","data"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/sobjects/"+a.name+"/"+a.fieldName+"/"+a.fieldValue+"?_HttpMethod=PATCH",type:"POST",data:a.data})};
ConnectedApp.prototype.query=function(a){var b=null;this.operations.validate(a,{authorized:!0,required:["soql"]}).then(function(){b=a.nextRecordsUrl?this.instanceUrl+a.nextRecordsUrl:this.instanceUrl+"/services/data/"+this.apiVersion+"/query?q="+encodeURIComponent(a.soql||"")}).sendRequest(a,{url:b})};
ConnectedApp.prototype.searchQuery=function(a){this.operations.validate(a,{authorized:!0,required:["sosl"]}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/search?q="+encodeURIComponent(a.sosl||"")})};ConnectedApp.prototype.searchScopeOrder=function(a){this.operations.validate(a,{authorized:!0}).sendRequest(a,{url:this.instanceUrl+"/services/data/"+this.apiVersion+"/search/scopeOrder"})};
ConnectedApp.prototype.loginApi=function(a){var b=null,c=this;this.operations.validate(a,{required:["username","password"]}).then(function(){b=copyProperties(a);b.success=function(b,e){parseAuthResponse.call(c,b);a.success&&a.success(b,e)}}).sendRequest(b,{url:this.loginUrl||DEFAULT_LOGINAPI_URL,type:"POST",contentType:"application/x-www-form-urlencoded; charset=utf-8",accept:"application/json",headers:[],data:{grant_type:"password",username:a.username,password:a.password+(a.securityToken||this.securityToken||
""),client_id:this.consumerKey,client_secret:this.consumerSecret}})};
ConnectedApp.prototype.login=function(a){function b(a){var i=decodeURIComponent(a.url);if(0===i.lastIndexOf(l+"#",0)){var g=i.substring(l.length+1);if(g&&0<g.length){i={};if(g){var g=g.split("&"),k;for(k in g)if(g.hasOwnProperty(k)){var m=g[k].split("=");i[m[0]]=decodeURIComponent(m[1])}}"undefined"===typeof i.access_token?i.message="OAuth access token is undefined":(parseAuthResponse.call(c,i),c.oauthHeader="OAuth "+c.accessToken,h=!0);e=i}f.removeEventListener("beforeload",b);f.removeEventListener("load",
b);d&&d.close()}j&&"load"==a.type&&(d.remove(j),j=null)}var c=this,h=!1,e={},d,f,i,l=this.redirectUri,g={url:getAuthorizeUrl(this.loginUrl||DEFAULT_LOGIN_URL,this.consumerKey,this.redirectUri)};a.window?d=a.window:(d=Ti.UI.createWindow({title:a.title||"salesforce",width:a.width||"100%",height:a.height||"100%"}),"android"!=Ti.Platform.osname&&(i=Ti.UI.createButton({title:"Close"}),i.addEventListener("click",function(){d.close()}),d.leftNavButton=i));d.addEventListener("close",function(){Ti.API.debug("SalesForce Login Successful - Token: "+
c.accessToken);h?(g.status=200,g.statusText=STATUS_OK,a.success&&a.success(e,g)):(g.status=401,g.statusText=STATUS_ERROR,e&&!e.message&&(e.message="Login cancelled"),a.error&&a.error(e,g));f=d=j=e=null});f=a.webView?a.webView:Ti.UI.createWebView({scalesPageToFit:a.scalesPageToFit||!0,showScrollbars:a.showScrollbars||!0});f.url=g.url;f.addEventListener("beforeload",b);f.addEventListener("load",b);var j=Ti.UI.createLabel({text:"Loading, please wait...",color:"black",width:Ti.UI.SIZE||"auto",height:Ti.UI.SIZE||
"auto",zIndex:100});d.add(f);d.add(j);d.open({modal:!0})};ConnectedApp.prototype.logout=function(a){this.refreshToken=this.accessToken=this.instanceUrl=null;this.isLoggedIn=!1;Ti.API.debug("SalesForce logout Successful");a.success&&a.success({},{status:200,statusText:STATUS_OK})};
ConnectedApp.prototype.refresh=function(a){var b=null,c=this,b=copyProperties(a);b.success=function(b,e){parseAuthResponse.call(c,b);a.success&&a.success(b,e)};this.operations.sendRequest(b,{url:this.loginUrl||DEFAULT_LOGINAPI_URL,type:"POST",contentType:"application/x-www-form-urlencoded; charset=utf-8",accept:"application/json",data:{grant_type:"refresh_token",refresh_token:a.refreshToken||this.refreshToken,client_id:this.consumerKey,client_secret:this.consumerSecret}})};
function Operations(a){this.host=a}Operations.prototype.nop=function(){return{then:function(){return this},validate:function(){return this},sendRequest:function(){return this}}};Operations.prototype.then=function(a){return a.apply(this.host,arguments)||this};
Operations.prototype.validate=function(a,b){var c=null,h=[];if(b)for(v in b){if(b.hasOwnProperty(v))switch(v){case "authorized":this.host.isLoggedIn||(c="Not authorized. Please log in.");break;case "required":b[v].forEach(function(b){a[b]||h.push(b)});0<h.length&&(c="Missing parameter(s): "+h.join(","));break;default:throw"Unknown validation: "+v;}if(c)return Ti.API.error(c),a.error&&a.error({message:c},{}),this.nop()}return this};
Operations.prototype.sendRequest=function(a,b){b.type=b.type||"GET";b.headers=b.headers||this.host.headers;b.timeout=b.timeout||a.timeout||this.host.timeout;b.success=b.success||a.success;b.error=b.error||a.error;b.progress=b.progress||a.progress;b.beforeSend=b.beforeSend||a.beforeSend;b.contentType=b.contentType||a.contentType||this.host.contentType;b.accept=b.accept||a.accept||this.host.accept;httpRequest(b);return this};
function getAuthorizeUrl(a,b,c){return a+"?display=touch&response_type=token&client_id="+encodeURIComponent(b)+"&redirect_uri="+encodeURIComponent(c)}
function parseAuthResponse(a){this.accessToken=a.access_token||null;this.instanceUrl=a.instance_url||null;this.currentUser=null;if(a.id){var b=/\/id\/(.*)$/.exec(a.id);b&&2==b.length&&(this.currentUser=b[1]);Ti.API.debug(this.currentUser)}a.refresh_token&&(this.refreshToken=a.refresh_token);this.isLoggedIn=!0;this.headers=[{name:"Authorization",value:"OAuth "+this.accessToken},{name:"X-User-Agent",value:"salesforce-toolkit-rest-javascript/"+this.apiVersion}]}
function copyProperties(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function isJSON(a){return a&&a.match(/application\/json/i)}function isXML(a){return a&&a.match(/application\/xml/i)}
var errorDetails={400:"The request could not be understood, usually because the JSON or XML body has an error.",401:"The account used has expired or is invalid.",403:"The request has been refused. Verify that the logged-in user has appropriate permissions.",404:"404: Resource not found.",405:"The method specified in the Request-Line is not allowed for the resource specified in the URI.",415:"The entity specified in the request is in a format that is not supported by specified resource for the specified method.",
500:"An error has occurred within Force.com, so the request could not be completed."};
function httpRequest(a){function b(a,b){var c;d.contentType=a.getResponseHeader("Content-Type");if((c=a.responseText)&&0<c.length)d.bytesReceived=c.length;if(isJSON(d.contentType))try{e=JSON.parse(c)}catch(f){e={}}else isXML(d.contentType)?e=a.responseXML:b&&d.contentType&&(e=a.responseData||{},d.bytesReceived=e?e.length:0)}var c,h,e={},d={url:a.url,bytesSent:0,bytesReceived:0,time:0},f=Ti.Network.createHTTPClient();f.timeout=a.timeout||DEFAULT_TIMEOUT;"mobileweb"===Ti.Platform.osname&&(f.withCredentials=
!0);f.onload=function(){b(this,!0);d.status=this.status;d.statusText=this.statusText;Ti.API.debug("Request succeeded ("+d.bytesReceived+" bytes, "+d.time+" ms)");a.success&&a.success(e,d);e=d=null};f.onerror=function(c){c=c||{};b(this,!1);e&&e instanceof Array&&(e=e[0]||{});d.status=this.status;d.statusText=this.statusText;e.errorCode=e.errorCode||c.code;e.details=errorDetails[this.status];e.message=e.message||c.error||e.details||"HTTP/S request failed";Ti.API.debug("Network error: "+e.message+" ("+
d.bytesReceived+" bytes, "+d.time+" ms)");a.error&&a.error(e,d);e=d=null};f.onreadystatechange=function(){switch(this.readyState){case 1:d.time=new Date;break;case 4:d.time=new Date-d.time}};a.type=a.type?a.type:"GET";a.progress&&(a.type.match(/get/i)?f.ondatastream=function(b){a.progress(b.progress)}:a.type.match(/post/i)&&(f.onsendstream=function(b){a.progress(b.progress)}));Ti.API.debug("reqUri: "+a.url);f.open(a.type,a.url);if(a.headers)for(c=0,h=a.headers.length;c<h;c++)f.setRequestHeader(a.headers[c].name,
a.headers[c].value);a.accept&&f.setRequestHeader("Accept",a.accept);if((c=a.data)&&a.contentType)f.setRequestHeader("Content-Type",a.contentType),"object"===typeof c&&(isJSON(a.contentType)?c=JSON.stringify(c):isXML(a.contentType)&&(c=Ti.XML.serializeToString(c)));f.setRequestHeader("Accept-Encoding","gzip");d.bytesSent=c&&c.length||0;a.beforeSend&&a.beforeSend(f);Ti.API.debug("Sending request ("+d.bytesSent+" bytes)");f.send(c)};